<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="UTF-8">
    <title>uhppoted-httpd</title>
    <link rel="icon"             href="images/favicon.svg">
    <link rel="mask-icon"        href="images/favicon-mask.svg" color="#000000">
    <link rel="apple-touch-icon" href="images/favicon-180x180.png">
    <link rel="manifest"         href="manifest.json">
    <link rel="stylesheet"       href="css/uhppoted.css" type="text/css">
  </head>

  <body> 
    <div id="content">
      
      <!-- LOGO -->
      <div id="logo">
        <img src="images/logo.png"  />
      </div>
      
      <div></div>
      <div></div>
      
      <div id="main">

        <!-- LOGIN -->
        <fieldset id="login">
          <legend>{{.Login.Legend}}</legend>
          <form action="/authorizexxx" method="POST" onsubmit="login(event)"> 
            <div class="field">
              <input id="uid" name="uid" type="text" size="28" placeholder="{{.Login.UserID.Hint}}"  required value="admin" />
            </div>
            <div class="field">
              <input id="pwd" name="pwd" type="password" size="28" placeholder="{{.Login.Password.Hint}}" required value="uhppotedx" />
              <img id="eye" src="images/eye-solid.svg" onclick="showHidePassword()"/>
            </div>
            <button action="submit">{{.Login.Ok.Label}}</button>
          </form>
          <div class="message"><p id="message"></p></div>
        </fieldset>

      </div>
    </div>
  </body>

  <!-- SCRIPTS -->
 
  <script>
    function showHidePassword() {
      let pwd = document.getElementById("pwd");
      let eye = document.getElementById("eye");

      if (pwd.type === 'password') {
          pwd.type = 'text';
          eye.src  = "images/eye-slash-solid.svg"
       } else {
          pwd.type = 'password';
          eye.src  = "images/eye-solid.svg"
       }
    }

    async function postAsForm(url='', data={}) {
      let pairs = [];
      for (name in data) {
        pairs.push(encodeURIComponent(name) + '=' + encodeURIComponent(data[name]));
      }

      const response = await fetch(url, { method: 'POST', 
                                          mode: 'cors',
                                          cache: 'no-cache',
                                          credentials: 'same-origin',
                                          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                                          redirect: 'follow', 
                                          referrerPolicy: 'no-referrer', 
                                          body: pairs.join('&').replace( /%20/g,'+')
                                        });
      return response; 
    }

    async function postAsJSON(url='', data={}) {
      const response = await fetch(url, { method: 'POST', 
                                          mode: 'cors',
                                          cache: 'no-cache',
                                          credentials: 'same-origin',
                                          headers: { 'Content-Type': 'application/json' },
                                          redirect: 'follow', 
                                          referrerPolicy: 'no-referrer', 
                                          body: JSON.stringify(data)
                                        });
      return response; 
    }

    function login(event) {
      let message = document.getElementById('message')

      event.preventDefault();

      message.innerText = "";

      let credentials = { 
        uid: document.getElementById('uid').value,
        pwd: document.getElementById('pwd').value
      }

      postAsForm('/authenticate', credentials)
        .then(response => { 
            if (response.status == 200 && response.redirected) {
              window.location = response.url;
            } else {
              return response.text()
            }
          })
        .then(msg => { message.innerText = msg })
        .catch(function(err) { console.error(err) });

      // postAsJSON('/authenticate', credentials)
      //   .then(response => { 
      //         if (response.status == 200 && response.redirected) {
      //           window.location = response.url;
      //         } else {
      //           return response.text()
      //         }
      //     })
      //   .then(msg => { message.innerText = msg })
      //   .catch(function(err) { console.error(err) });
    }

  </script>
</html>


